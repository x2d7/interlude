name: ci/test-and-coverage-html

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main # срабатывает на merge в main

jobs:
  test-and-coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go 1.26
        uses: actions/setup-go@v5
        with:
          go-version: '1.26'
          cache: true

      - name: Ensure code is formatted
        run: |
          unformatted=$(gofmt -s -l ./...)
          if [ -n "$unformatted" ]; then
            echo "Unformatted files:"
            echo "$unformatted"
            exit 1
          fi

      - name: Run tests with coverage
        run: |
          go test -race -covermode=atomic -coverpkg=./... -coverprofile=coverage.out ./...
          go tool cover -func=coverage.out > coverage.txt
          go tool cover -html=coverage.out -o coverage.html
          grep '^total:' coverage.txt || true
          echo "coverage.html and coverage.txt produced."

      - name: Fail if coverage drops below 75%
        if: github.ref == 'refs/heads/main'
        run: |
          coverage=$(grep '^total:' coverage.txt | awk '{print $3}' | tr -d '%')
          echo "Total coverage: $coverage%"
          awk -v cov="$coverage" 'BEGIN {
            if (cov < 75) {
              print "Coverage " cov "% is below threshold of 75%"
              exit 1
            }
          }'

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.html
            coverage.txt
            coverage.out